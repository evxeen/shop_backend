generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id            Int                 @id @default(autoincrement())
  telegramId    String              @unique
  username      String?
  phone         String?
  email         String?             @unique
  passwordHash  String?
  telegramData  Json?
  role          UserRole            @default(USER)

  // –°–∏—Å—Ç–µ–º–∞ –±–æ–Ω—É—Å–æ–≤
  bonusBalance  Float               @default(0)
  totalSpent    Float               @default(0)
  ordersCount   Int                 @default(0)

  referralCode  String?             @unique
  referrerId    Int?
  referrer      User?               @relation("Referrals", fields: [referrerId], references: [id])
  referrals     User[]              @relation("Referrals")

  // –°–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ –∞–¥—Ä–µ—Å–∞
  savedAddresses Json?

  // üî• –î–û–ë–ê–í–õ–Ø–ï–ú –û–ë–†–ê–¢–ù–´–ï –°–í–Ø–ó–ò
  orders        Order[]
  bonusTransactions BonusTransaction[] // –û–±—Ä–∞—Ç–Ω–∞—è —Å–≤—è–∑—å –∫ BonusTransaction

  createdAt     DateTime            @default(now())
  updatedAt     DateTime            @updatedAt
}

model Order {
  id            Int                 @id @default(autoincrement())
  customerName  String
  customerPhone String
  customerEmail String?
  address       String
  status        String              @default("pending")
  totalPrice    Float
  createdAt     DateTime            @default(now())

  // –°–≤—è–∑–∏
  items         OrderItem[]
  user          User?               @relation(fields: [userId], references: [id])
  userId        Int?

  // üî• –î–û–ë–ê–í–õ–Ø–ï–ú –û–ë–†–ê–¢–ù–£–Æ –°–í–Ø–ó–¨
  bonusTransactions BonusTransaction[] // –û–±—Ä–∞—Ç–Ω–∞—è —Å–≤—è–∑—å –∫ BonusTransaction
}

model OrderItem {
  id        Int     @id @default(autoincrement())
  orderId   Int
  productId Int
  quantity  Int
  price     Float
  order     Order   @relation(fields: [orderId], references: [id], onDelete: Cascade)
  product   Product @relation(fields: [productId], references: [id])
}

model Product {
  id          Int         @id @default(autoincrement())
  name        String
  description String?
  price       Float
  stock       Int         @default(0)
  category    String
  imageUrl    String?
  isActive    Boolean     @default(true)
  createdAt   DateTime    @default(now())
  orderItems  OrderItem[]
}

// üî• –ú–û–î–ï–õ–¨ –î–õ–Ø –ò–°–¢–û–†–ò–ò –ë–û–ù–£–°–û–í
model BonusTransaction {
  id          Int      @id @default(autoincrement())
  userId      Int
  user        User     @relation(fields: [userId], references: [id])
  amount      Float
  type        String   // "loyalty_5percent", "referral_bonus", "birthday_bonus", "special_offer"
  orderId     Int?
  order       Order?   @relation(fields: [orderId], references: [id])
  description String
  createdAt   DateTime @default(now())
}

enum UserRole {
  USER
  ADMIN
}